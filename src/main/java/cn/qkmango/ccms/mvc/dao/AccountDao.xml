<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.qkmango.ccms.mvc.dao.AccountDao">

    <insert id="insert">
        insert into t_account
            (id, password, state, role, department)
        values (#{id}, #{password}, #{state}, #{role}, #{department})
    </insert>

    <select id="getAccountPassword" resultType="java.lang.String">
        select password
        from
        <if test="type == @cn.qkmango.ccms.domain.bind.Role@user">
            t_user
        </if>
        <if test="type == @cn.qkmango.ccms.domain.bind.Role@admin">
            t_admin
        </if>
        <if test="type == @cn.qkmango.ccms.domain.bind.Role@pos">
            t_pos
        </if>
        where id = #{id}
    </select>


    <update id="updatePassword">
        update
        <if test="role == @cn.qkmango.ccms.domain.bind.Role@user">
            t_user
        </if>
        <if test="role == @cn.qkmango.ccms.domain.bind.Role@admin">
            t_admin
        </if>
        <if test="role == @cn.qkmango.ccms.domain.bind.Role@pos">
            t_pos
        </if>
        set password = #{newPassword}
        where id = #{id} and password = #{oldPassword}
    </update>

<!--    <select id="loginUser" resultType="cn.qkmango.ccms.domain.entity.User">-->
<!--        select id, name, password-->
<!--        from t_user-->
<!--        where id = #{id}-->
<!--        and unsubscribe = 0;-->
<!--    </select>-->

<!--    <select id="loginPos" resultType="cn.qkmango.ccms.domain.entity.Pos">-->
<!--        select id, name, type, password-->
<!--        from t_pos-->
<!--        where id = #{id}-->
<!--    </select>-->

<!--    <select id="loginAdmin" resultType="cn.qkmango.ccms.domain.entity.Account">-->
<!--        select id, name, password-->
<!--        from t_admin-->
<!--        where id = #{id}-->
<!--    </select>-->

    <select id="userAccountInfo" resultMap="UserAccountInfoVO">
        select u.id as account_id,
        u.name as account_name,
        u.email as account_email,
        'user' as account_role,

        u.idCard as user_idcard,
        u.unsubscribe as user_unsubscribe,

        ca.balance as card_balance,
        ca.`lock` as card_lock,

        cz.name as clazz_name,
        sp.name as specialized_name,
        fa.name as faculty_name
        from t_user u
        left join t_card ca on ca.user = u.id
        left join t_clazz cz on cz.id = u.clazz
        left join t_specialty sp on sp.id = cz.specialty
        left join t_faculty fa on fa.id = sp.faculty
        where u.id = #{id}
    </select>

    <select id="adminAccountInfo" resultMap="AccountInfoVO">
        select id,
        name,
        email,
        'admin' as type
        from t_admin
        where id = #{id}
    </select>

    <update id="updateEmail">
        update
        <if test="account.role == @cn.qkmango.ccms.domain.bind.Role@user">
            t_user
        </if>
        <if test="account.role == @cn.qkmango.ccms.domain.bind.Role@admin">
            t_admin
        </if>
        set email = #{email}
        where id = #{account.id}
    </update>

    <update id="update">
        update
            t_account
        <if test="password != null and password != ''">
            set password = #{password}
        </if>
        <if test="state != null">
            set state = #{state}
        </if>
        where id = #{id}
    </update>


    <select id="getRecordById" resultType="cn.qkmango.ccms.domain.entity.Account">
        select id,
               state,
               role,
               department
        from t_account
        where id = #{id}
    </select>

    <select id="login" resultType="cn.qkmango.ccms.domain.entity.Account">
        select id,
               password,
               state,
               role
        from t_account
        where id = #{id}
          and role = #{role}
    </select>

    <select id="list" resultType="cn.qkmango.ccms.domain.entity.Account">
        select SQL_CALC_FOUND_ROWS
        id,
        state,
        role,
        department
        from t_account
        <where>
            <if test="param != null">
                <if test="param.id != null and param.id != ''">
                    id = #{param.id}
                </if>
                <if test="param.state != null">
                    and state = #{param.state}
                </if>
                <if test="param.role != null">
                    and `role` = #{param.role}
                </if>
                <if test="param.department != null">
                    and department = #{param.department}
                </if>
            </if>
        </where>
        order by id asc
        <if test="pagination == true">
            LIMIT #{skipCount},#{limit}
        </if>
    </select>


    <resultMap id="UserAccountInfoVO" type="cn.qkmango.ccms.domain.vo.UserAccountInfoVO">
        <association property="account">
            <id property="id" column="account_id"/>
            <result property="name" column="account_name"/>
            <result property="email" column="account_email"/>
            <result property="role" column="account_role"/>
        </association>
        <association property="user">
            <result property="idCard" column="user_idcard"/>
            <result property="unsubscribe" column="user_unsubscribe"/>
        </association>
        <association property="card">
            <result property="balance" column="card_balance"/>
            <result property="lock" column="card_lock"/>
        </association>
        <association property="clazz">
            <result property="name" column="clazz_name"/>
        </association>
        <association property="specialty">
            <result property="name" column="specialized_name"/>
        </association>
        <association property="faculty">
            <result property="name" column="faculty_name"/>
        </association>
    </resultMap>

    <resultMap id="AccountInfoVO" type="cn.qkmango.ccms.domain.vo.AccountInfoVO">
        <association property="account">
            <id property="id" column="id"/>
            <result property="name" column="name"/>
            <result property="email" column="email"/>
            <result property="role" column="type"/>
        </association>
    </resultMap>


</mapper>
