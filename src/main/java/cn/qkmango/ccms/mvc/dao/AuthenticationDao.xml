<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.qkmango.ccms.mvc.dao.AuthenticationDao">

    <select id="authentication" resultType="cn.qkmango.ccms.domain.entity.Account">
        SELECT id,name
        FROM
        <choose>
            <when test="permission == @cn.qkmango.ccms.domain.bind.PermissionType@user">t_user</when>
            <when test="permission == @cn.qkmango.ccms.domain.bind.PermissionType@admin">t_admin</when>
        </choose>

        WHERE
        <choose>
            <when test="platform == @cn.qkmango.ccms.domain.auth.PlatformType@gitee">gitee_uid = #{uid}</when>
            <when test="platform == @cn.qkmango.ccms.domain.auth.PlatformType@dingtalk">dingtalk_uid = #{uid}</when>
        </choose>

        <if test="permission == @cn.qkmango.ccms.domain.bind.PermissionType@user">and unsubscribe = 0;</if>
    </select>

    <update id="toBind2">
        update
        <choose>
            <when test="account.permissionType == @cn.qkmango.ccms.domain.bind.PermissionType@user">t_user</when>
            <when test="account.permissionType == @cn.qkmango.ccms.domain.bind.PermissionType@admin">t_admin</when>
        </choose>
        set
        <choose>
            <when test="platform.type == @cn.qkmango.ccms.domain.auth.PlatformType@gitee">
                gitee_uid = #{platform.uid}
            </when>
            <when test="platform.type == @cn.qkmango.ccms.domain.auth.PlatformType@dingtalk">
                dingtalk_uid = #{platform.uid}
            </when>
        </choose>
        where id = #{account.id}
    </update>
    <insert id="toBind">
        insert into t_open_platform(account, account_type, type, uid)
        values(#{account.id},#{account.permissionType},#{platform.type},#{platform.uid});
    </insert>


    <update id="unbind">
        update
        <choose>
            <when test="account.permissionType == @cn.qkmango.ccms.domain.bind.PermissionType@user">t_user</when>
            <when test="account.permissionType == @cn.qkmango.ccms.domain.bind.PermissionType@admin">t_admin</when>
        </choose>
        set
        <choose>
            <when test="platform == @cn.qkmango.ccms.domain.auth.PlatformType@gitee">gitee_uid = null</when>
            <when test="platform == @cn.qkmango.ccms.domain.auth.PlatformType@dingtalk">dingtalk_uid = null</when>
        </choose>
        where id = #{account.id}
    </update>


    <select id="openPlatformBindState" resultMap="OpenPlatformBindStateMap">
        select
        'gitee' as gitee_type,
        gitee_uid,
        if(gitee_uid is null, 0, 1) as gitee_state,

        dingtalk_uid,
        'dingtalk' as dingtalk_type,
        if(dingtalk_uid is null, 0, 1) as dingtalk_state
        from
        <choose>
            <when test="permissionType == @cn.qkmango.ccms.domain.bind.PermissionType@user">t_user</when>
            <when test="permissionType == @cn.qkmango.ccms.domain.bind.PermissionType@admin">t_admin</when>
        </choose>
        where id = #{id}
    </select>

    <select id="isBind" resultType="java.lang.Boolean">
        <![CDATA[
            select if(count(id)=1,true,false) as state
            from t_open_platform
            where account = #{account.id}
            and type = #{platform.type}
            and account_type = #{account.permissionType}
        ]]>
    </select>

    <resultMap id="OpenPlatformBindStateMap" type="cn.qkmango.ccms.domain.vo.OpenPlatformBindState">
        <association property="gitee">
            <result property="type" column="gitee_type"/>
            <result property="state" column="gitee_state"/>
            <result property="uid" column="gitee_uid"/>
        </association>
        <association property="dingtalk">
            <result property="type" column="dingtalk_type"/>
            <result property="state" column="dingtalk_state"/>
            <result property="uid" column="dingtalk_uid"/>
        </association>
    </resultMap>
</mapper>
