<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.qkmango.ccms.mvc.dao.AuthenticationDao">

    <update id="toBind2">
        update
        <choose>
            <when test="account.role == @cn.qkmango.ccms.domain.bind.Role@user">t_user</when>
            <when test="account.role == @cn.qkmango.ccms.domain.bind.Role@admin">t_admin</when>
        </choose>
        set
        <choose>
            <when test="platform.type == @cn.qkmango.ccms.domain.auth.PlatformType@gitee">
                gitee_uid = #{platform.uid}
            </when>
            <when test="platform.type == @cn.qkmango.ccms.domain.auth.PlatformType@dingtalk">
                dingtalk_uid = #{platform.uid}
            </when>
        </choose>
        where id = #{account.id}
    </update>
    <insert id="toBind">
        insert into t_open_platform(account, role, type, uid)
        values(#{account.id},#{account.role},#{platform.type},#{platform.uid});
    </insert>


    <delete id="unbind">
        DELETE FROM t_open_platform
        WHERE account=#{account.id}
        AND role=#{account.role}
        AND type=#{platform}
    </delete>

    <select id="openPlatformBindState" resultType="cn.qkmango.ccms.domain.entity.OpenPlatform">
        SELECT 'dingtalk' as type, IF(COUNT(*),TRUE,FALSE) as state
        FROM t_open_platform
        WHERE account=#{id}
        and role=#{role}
        and type='dingtalk'

        UNION ALL

        SELECT 'gitee' as type, IF(COUNT(*),TRUE,FALSE) as state
        FROM t_open_platform
        WHERE account=#{id}
        and role=#{role}
        and type='gitee'

        UNION ALL

        SELECT 'alipay' as type, IF(COUNT(*),TRUE,FALSE) as state
        FROM t_open_platform
        WHERE account=#{id}
        and role=#{role}
        and type='alipay'
    </select>

    <select id="isBind" resultType="java.lang.Boolean">
        <![CDATA[
            select if(count(id)=1,true,false) as state
            from t_open_platform
            where account = #{account.id}
            and type = #{platform.type}
            and role = #{account.role}
        ]]>
    </select>



    <resultMap id="OpenPlatformBindStateMap" type="cn.qkmango.ccms.domain.vo.OpenPlatformBindState">
        <association property="gitee">
            <result property="type" column="gitee_type"/>
            <result property="state" column="gitee_state"/>
            <result property="uid" column="gitee_uid"/>
        </association>
        <association property="dingtalk">
            <result property="type" column="dingtalk_type"/>
            <result property="state" column="dingtalk_state"/>
            <result property="uid" column="dingtalk_uid"/>
        </association>
    </resultMap>
</mapper>
