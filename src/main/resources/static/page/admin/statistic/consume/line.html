<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <title>消费曲线图</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../../lib/layui-v2.6.3/css/layui.css" media="all">
    <link rel="stylesheet" href="../../../../lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all">
    <link rel="stylesheet" href="../../../../css/public.css" media="all">
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">
        <fieldset class="table-search-fieldset">
            <legend>统计信息</legend>
            <div style="margin: 10px 10px 10px 10px">
                <form class="layui-form layui-form-pane" lay-filter='consume' id="consume">
                    <div class="layui-form-item layui-row">

                        <div class="layui-form-item layui-col-md4">
                            <label class="layui-form-label">时间范围</label>
                            <div class="layui-input-block">
                                <input type="text" name="range" id="range" class="layui-input" autocomplete="off">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <button type="submit" class="layui-btn layui-btn-primary" lay-submit
                                    lay-filter="data-search-btn"><i class="fa fa-search"></i> 统计
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </fieldset>

        <div id="echarts-records" style="width: 100%;min-height:500px"></div>
    </div>
</div>
<script src="../../../../lib/util/color.js"></script>
<script src="../../../../lib/util/utils.js"></script>
<script src="../../../../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script src="../../../../js/lay-config.js" charset="utf-8"></script>
<script src="../../../../lib/echarts/echarts.min.js" charset="utf-8"></script>

<script>
    let $;
    layui.use(['layer', 'laydate', 'form'], function () {
        $ = layui.jquery;
        const form = layui.form;
        const layer = layui.layer;
        const laydate = layui.laydate;

        // echarts 窗口缩放自适应
        window.onresize = function () {
            echartsRecords.resize();
        }

        // 日期范围
        laydate.render({
            elem: '#range',
            type: 'date',
            range: true,
            min: '2000-1-1',
            max: '2099-12-31'
        });

        // Echarts 初始化
        const echartsRecords = echarts.init(document.getElementById('echarts-records'));
        // Echarts 配置
        const optionRecords = {
            title: {
                text: '消费金额曲线图',
                left: 'center',
                top: 30
            },
            xAxis: {
                type: 'category',
                name: '日期/天',
                axisPointer: {
                    show: true,
                    type: 'shadow',
                    label: {
                        show: true
                    }
                },
            },
            yAxis: {
                type: 'value',
                name: '金额/元'
            },
            series: [],
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            toolbox: {
                orient: 'vertical',
                top: 60,
                feature: {
                    dataZoom: {
                        yAxisIndex: 'none'
                    },
                    restore: {},
                    saveAsImage: {}
                }
            },
            grid: {
                left: 10,
                right: 70,
                bottom: 10,
                top: 80,
                containLabel: true
            },
            legend: {
                show: true,
                top: 30,
                left: 'right',
            },
        };

        //获取数据并渲染
        let transData = getEchartsData();
        optionRecords.xAxis.data = transData.xAxis;
        optionRecords.series = transData.series;
        echartsRecords.setOption(optionRecords);

        // 监听搜索操作
        form.on('submit(data-search-btn)', function (data) {
            let transData = getEchartsData(data.field.range);
            optionRecords.xAxis.data = transData.xAxis;
            optionRecords.series = transData.series;
            echartsRecords.setOption(optionRecords);

            return false;
        });

        return false;

    });
</script>
<script>
    /**
     * 获取数据
     * @param param
     * @returns {*}
     */
    function getEchartsData(param) {
        let data;
        let range = {};
        if (typeof (param) === 'string') {
            const split = param.split(' - ');
            range.startTime = split[0];
            range.endTime = split[1];
        }
        $.ajax({
            // url: '../../../../statistic/consume/statistic-price-by-day-and-type.do?',
            url: './index.test.json',
            data: range,
            dataType: 'json',
            async: false,
            success: function (res) {
                if (res.success) {
                    data = transition(res.data);
                    return;
                }
                layer.msg(res.message, {icon: 2});
            },
            error: function (jqXHR, textStatus, errorThrown) {
                layer.msg(jqXHR.status + '', {icon: 2});
            }
        })
        return data;
    }

    /**
     * 转换数据
     * 将后端返回的数据转换为echarts所需的数据
     * @param data
     * @returns {{xAxis: *[], series: [{areaStyle: {opacity: number}, data: *[], color: string, name: string, type: string, smooth: boolean},{areaStyle: {opacity: number}, data: *[], color: string, name: string, type: string, smooth: boolean},{areaStyle: {opacity: number}, data: *[], color: string, name: string, type: string, smooth: boolean},{areaStyle: {opacity: number}, data: *[], color: string, name: string, type: string, smooth: boolean},{areaStyle: {color: string, origin: string, opacity: number}, data: *[], lineStyle: {color: string, width: number}, name: string, itemStyle: {color: string}, type: string, smooth: boolean}]}}
     */
    function transition(data) {
        //按照日期分组
        data = utils.groupBy(data, item => item.date);
        let xAxis = [];
        let series = [
            {
                name: '水费',
                data: [],
                type: 'line',
                color: '#0969da',
                smooth: true,
                areaStyle: {
                    opacity: 0.05
                }
            },
            {
                name: '电费',
                data: [],
                type: 'line',
                color: '#FFB800',
                smooth: true,
                areaStyle: {
                    opacity: 0.05
                }
            },
            {
                name: '餐费',
                data: [],
                type: 'line',
                color: '#ff5722',
                smooth: true,
                areaStyle: {
                    opacity: 0.05
                }
            },
            {
                name: '其他',
                data: [],
                type: 'line',
                color: '#C2C2C2',
                smooth: true,
                areaStyle: {
                    opacity: 0.05
                }
            },
            {
                name: '总计',
                data: [],
                type: 'line',
                smooth: true,
                lineStyle: {
                    color: color.green,
                    width: 3,
                },
                itemStyle: {
                    color: color.green,
                },
                areaStyle: {
                    // 0.05透明度
                    color: color.green,
                    opacity: 0.1,
                    origin: 'end'
                }
            },
        ];

        let dateList = Object.keys(data).sort();
        dateList.forEach(item => {
            xAxis.push(layui.util.toDateString(Number.parseInt(item), 'yyyy-MM-dd'));
        });

        //填充空数据
        for (let i = 0; i < dateList.length; i++) {
            series[0].data[i] = 0;
            series[1].data[i] = 0;
            series[2].data[i] = 0;
            series[3].data[i] = 0;
            series[4].data[i] = 0;
        }

        //循环填充数据
        dateList.forEach((item, index) => {
            let itemData = data[item];
            itemData.forEach(item => {
                if (item.type === 'ALL') {
                    series[4].data[index] += item.price / 100;
                    return;
                }
                switch (item.consumeType) {
                    case 'WATER':
                        series[0].data[index] = item.price / 100;
                        break;
                    case 'ELECTRIC':
                        series[1].data[index] = item.price / 100;
                        break;
                    case 'MEAL_EXPENSE':
                        series[2].data[index] = item.price / 100;
                        break;
                    case 'OTHER':
                        series[3].data[index] += item.price / 100;
                        break;
                }

            });
        });
        return {xAxis, series}
    }
</script>
</body>
</html>
